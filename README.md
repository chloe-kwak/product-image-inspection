# 🔍 상품 이미지 검수 시스템

OpenCV + Amazon Bedrock Nova AI를 활용한 2단계 하이브리드 이미지 품질 검수 시스템

## 🚀 주요 기능

- **1단계**: OpenCV를 통한 정밀한 테두리 탐지
  - 중앙 95% 마스킹으로 제품 영역 제외
  - 9가지 색상 범위 지원
  - Canny 엣지 검출 알고리즘
- **2단계**: Nova AI를 통한 일반 품질 검수
- **실시간 웹 인터페이스**: Streamlit 기반
- **높은 정확도**: 90% 테스트 통과율

## 📋 시스템 요구사항

### Python 환경
- Python 3.8 이상
- pip 패키지 매니저

### AWS 계정
- AWS Bedrock 서비스 접근 권한
- Nova 모델 사용 권한
- (선택사항) DynamoDB 접근 권한

## 🛠️ 설치 방법

### 1. 의존성 설치
```bash
pip install -r requirements.txt
```

### 2. 환경 변수 설정 ⚠️ **필수**

**`.env` 파일이 없으면 애플리케이션이 실행되지 않습니다!**

```bash
# .env.example을 복사하여 .env 파일 생성
cp .env.example .env
```

### 3. AWS 설정
`.env` 파일을 열어 다음 정보를 입력하세요:

```bash
# AWS 자격 증명 (필수)
AWS_ACCESS_KEY_ID=your_access_key_here
AWS_SECRET_ACCESS_KEY=your_secret_key_here
AWS_REGION=us-east-1

# AI 모델 설정 (필수)
BEDROCK_MODEL_ID=us.amazon.nova-lite-v1:0

# 프롬프트 버전 (선택)
PROMPT_VERSION=v3.2

# DynamoDB 테이블 (선택)
DYNAMODB_TABLE_NAME=product-image-inspection
```

#### 📌 필수 설정 항목
- ✅ `AWS_ACCESS_KEY_ID` - AWS 액세스 키
- ✅ `AWS_SECRET_ACCESS_KEY` - AWS 시크릿 키
- ✅ `AWS_REGION` - AWS 리전
- ✅ `BEDROCK_MODEL_ID` - 사용할 AI 모델

#### 🔄 사용 가능한 모델
- `us.amazon.nova-lite-v1:0` - 빠르고 경제적 (권장)
- `us.amazon.nova-pro-v1:0` - 더 정확하고 상세한 분석
- `us.anthropic.claude-3-7-sonnet-20250219-v1:0` - Claude 모델 (선택사항)

**💡 모델 변경 방법**: `.env` 파일에서 `BEDROCK_MODEL_ID` 값을 변경하고 애플리케이션을 재시작하세요.

## 🖥️ 실행 방법

### Streamlit 웹 애플리케이션 실행
```bash
streamlit run two_stage_app.py
```

브라우저에서 `http://localhost:8502` 접속

## 📊 사용법

### 1. 단일 이미지 검수
1. 웹 인터페이스에서 이미지 URL 입력
2. "검수 실행" 버튼 클릭
3. 결과 확인:
   - `false`: 테두리 탐지됨 (반려)
   - `true`: 검수 통과 (승인)

### 2. 일괄 이미지 검수
1. "일괄 검수" 탭 선택
2. 여러 이미지 URL 입력 (줄바꿈으로 구분)
3. "일괄 검수 실행" 버튼 클릭
4. 결과를 json으로 다운로드 가능

## 🔧 시스템 구조

```
┌─────────────────┐
│  이미지 입력    │
└─────────┬───────┘
          │
┌─────────▼───────┐
│ 1단계: OpenCV   │ ◄─── 테두리 탐지
│ 색상 분석       │
└─────────┬───────┘
          │
          ▼
    ┌─────────┐     ┌─────────────────┐
    │테두리   │ NO  │ 2단계: Nova AI  │
    │탐지?    ├────►│ 일반 품질 검수  │
    │         │     │                 │
    └─────┬───┘     └─────────────────┘
          │ YES               │
          ▼                   ▼
    ┌─────────┐         ┌─────────┐
    │ FALSE   │         │검수 결과│
    │ (반려)  │         │반환     │
    └─────────┘         └─────────┘
```

## 🎯 탐지 가능한 테두리

### 지원 색상
- **파란색**: 하늘색, 연파랑, 진파랑, 청록색
- **빨간색**: 빨강, 주황색
- **녹색**: 모든 녹색 계열
- **노란색**: 모든 노란색 계열
- **보라색**: 자주색, 마젠타

### 탐지 기준
- **중앙 마스킹**: 95% (제품 영역 제외)
- **가장자리 영역**: 최외곽 2.5%만 분석
- **색상 범위**: 20% ~ 95% (제품 색상 제외)
- **엣지 임계값**: 15% 이상
- **신뢰도 임계값**: 15% 이상

### 탐지 방식
1. **색상 분석**: HSV 색공간에서 9가지 색상 범위 검사
2. **엣지 검출**: Canny 알고리즘으로 경계선 탐지
3. **중앙 제외**: 제품 영역(95%)을 마스킹하여 순수 배경만 분석
4. **종합 판정**: 색상(50%) + 엣지(50%) 가중치로 최종 판정

## 📈 성능 지표

- **테두리 탐지 정확도**: 90% (10개 테스트 기준)
- **처리 속도**: 이미지당 평균 0.1초 (OpenCV)
- **지원 형식**: JPG, PNG, WebP
- **최대 이미지 크기**: 제한 없음

## 🐛 문제 해결

### 일반적인 문제

1. **AWS 인증 오류**
   - `.env` 파일의 AWS 키 확인
   - Bedrock 서비스 권한 확인

2. **모듈 import 오류**
   - `pip install -r requirements.txt` 재실행
   - Python 가상환경 활용 권장

3. **이미지 다운로드 실패**
   - 이미지 URL 접근 가능 여부 확인
   - 방화벽 설정 확인

### 로그 확인
애플리케이션 실행 시 콘솔에 표시되는 로그를 통해 상세한 진단 정보를 확인할 수 있습니다.

## 📞 지원 및 문의

### 기술 지원
- 설치/실행 관련 문의
- 커스터마이징 요청
- 성능 최적화 상담

### 시스템 확장
- 추가 색상 범위 설정
- 커스텀 검수 기준 적용
- 대량 처리 최적화

## 📝 라이선스

이 시스템은 상용 라이선스로 제공됩니다. 무단 복제 및 배포를 금지합니다.

---
